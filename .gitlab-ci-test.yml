.job_test_template: &job_test_definition
  tags:
    - aphp
    - cicd
    - rsareth
  stage: test
  cache:
    key: "${CI_PROJECT_PATH}-${CI_BUILD_REF_SLUG}"
    paths:
      - .m2/repository
  artifacts:
    expire_in: 1 month
    paths:
      - spark-*/target/*-test-suites.zip
  script:
    - |
      MODULE_NAME=$(echo $CI_JOB_NAME | cut -d_ -f3)
      mvn -pl "${MODULE_NAME}" test
      test -d "${MODULE_NAME}/target/surefire-reports" && (cd "${MODULE_NAME}/target/" ; zip -r "${MODULE_NAME}"-test-suites.zip surefire-reports) || :;

.job_common_rules_if: &job_common_rules_if
  '$CI_COMMIT_TAG =~ /^[0-9]+\.[0-9]+\.[0-9]+/ || $CI_COMMIT_BRANCH != null'

job_test_spark-csv:
  <<: *job_test_definition
  rules:
    - if: *job_common_rules_if
      changes:
        - .gitlab-ci.yml
        - .gitlab-ci-test.yml
        - pom.xml
        - build.sh
        - spark-csv/pom.xml
        - spark-csv/**/*

job_test_spark-dataframe:
  <<: *job_test_definition
  rules:
    - if: *job_common_rules_if
      changes:
        - .gitlab-ci.yml
        - .gitlab-ci-test.yml
        - pom.xml
        - build.sh
        - spark-dataframe/pom.xml
        - spark-dataframe/**/*

job_test_spark-hive:
  <<: *job_test_definition
  rules:
    - if: *job_common_rules_if
      changes:
        - .gitlab-ci.yml
        - .gitlab-ci-test.yml
        - pom.xml
        - build.sh
        - spark-hive/pom.xml
        - spark-hive/**/*

job_test_spark-meta:
  <<: *job_test_definition
  rules:
    - if: *job_common_rules_if
      changes:
        - .gitlab-ci.yml
        - .gitlab-ci-test.yml
        - pom.xml
        - build.sh
        - spark-meta/pom.xml
        - spark-meta/**/*

job_test_spark-postgres:
  <<: *job_test_definition
  rules:
    - if: *job_common_rules_if
      changes:
        - .gitlab-ci.yml
        - .gitlab-ci-test.yml
        - pom.xml
        - build.sh
        - spark-postgres/pom.xml
        - spark-postgres/**/*

job_test_spark-quality:
  <<: *job_test_definition
  rules:
    - if: *job_common_rules_if
      changes:
        - .gitlab-ci.yml
        - .gitlab-ci-test.yml
        - pom.xml
        - build.sh
        - spark-quality/pom.xml
        - spark-quality/**/*

job_test_spark-query:
  <<: *job_test_definition
  rules:
    - if: *job_common_rules_if
      changes:
        - .gitlab-ci.yml
        - .gitlab-ci-test.yml
        - pom.xml
        - build.sh
        - spark-query/pom.xml
        - spark-query/**/*

job_test_spark-sync:
  <<: *job_test_definition
  rules:
    - if: *job_common_rules_if
      changes:
        - .gitlab-ci.yml
        - .gitlab-ci-test.yml
        - pom.xml
        - build.sh
        - spark-sync/pom.xml
        - spark-sync/**/*
